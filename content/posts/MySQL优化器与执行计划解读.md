---
title: "MySQL查询优化器与执行计划简介（要改）"
date: 2021-09-16T20:46:07+08:00
draft: true
tags: ["MySQL", "数据库"]
categories: ["数据库"]
featuredImagePreview: ""
summary: 解读SQL具体的执行流程以及MySQL查询优化器的常用优化方法，并结合日常问题介绍常用的分析、优化方法。
typora-root-url: ../../static
---

## SQL执行计划

SQL的执行计划。指数据库服务如何从实际存储中获取SQL语义所需的数据的具体计划过程，其中最主要的有两方面：

- 单表的访问方式（access method）
- 多表的`JOIN`方式

单表的访问方式简单来说就是”是否使用索引、用哪个索引“，然后还有具体扫描数据的方式等。

JOIN方式主要包括表的连接访问顺序和表数据比对算法。

这两方面内容确定后，一个SQL如何在物理意义上获取所需数据的方式就确定了。

举例

![image-20210930145224580](/img/mysql-plan/shot1.png)

而在MySQL中, 这个SQL的真实内部执行过程是这样的:

- 这里先考虑join中两个表的顺序, MySQL选择了users表作为驱动表.
- 由于筛选的amount条件并不在users表中, 作为驱动表, users被全表扫描了.
- 扫描得到的每一行记录, 相当于带着user_id字段与name字段的值, 去和accounts表进行逐行比对
- 比对过程中, accounts表将驱动表的每一个user_id在自己的user_id索引中进行寻找, 如果找到, 则从索引回表(using where)查看amount值是否符合>1000, 如果符合则确定是SQL语义所需, 结果命中.
- 以users表记录总数为上限, 不断循环, 直到users表记录的user_id全部在accounts表中比对完成, 组合所有命中结果, 返回给查询客户端.

可以看出, 执行计划就是MySQL对表结构和基础信息充分掌握, 对SQL语义充分理解后, 给自己制定的工作流程.  

但是这个例子又很奇怪, 这是一个乍看上去非常不合理的执行计划: 这个SQL根据语义, 我们通常应该觉得是先从accounts表中根据1000条件过滤出所需子集, 再拿这些结果的user_id去users表的主键循环比对并取出(甚至不用回表)name字段来最终组织结果集. 但是为啥MySQL要反过来走? 这里面原因可能很多, 比如两个表都很小, accounts表没有amount索引并且>1000条件的记录数其实较多等等... 综合下来, 还真有可能是这样看似不合理的执行计划反而性能更好, 这就是执行计划的选择性奥妙所在.

## MySQL查询优化器

在数据库中负责生成系统认为合理的执行计划的组件就被称为查询优化器(optimizer)，它的作用就是把输入的SQL转化为真实运行的执行计划（经过优化）

![image-20210930150237204](/img/mysql-plan/shot2.png)

MySQL查询优化器对每个SQL都有两种不同的优化机制

- 启发式优化（Heuristic）
- 基于成本的优化（CBO）

启发式优化是一种传统而标准的基于规则优化（Rule-Based-Optimization，简称RBO）的方法。体现在MySQL中，主要包括根据既定规则对SQL进行等价改写、并确定一些如分区消除等有规律可循的优化内容。举一些例子（发出来要去掉一些自己不理解的例子）：

- 条件简化类, 如改写恒等式, 消除恒不等式, 消除非空字段空等无效条件, 去除重组不必要的符号与格式, 预处理计算类条件等等
- 处理join类, 如子查询改为半连接, 消除外连接, 消除嵌套连接等等
- 处理union类, 主要是每个union子语句分开处理
- 分区消除, 排序等规则类优化, 视图重写等语意类优化

根据这些例子可以了解到，启发式优化在SQL包含子查询和关联查询时非常重要。对于一般SQL的索引选择等性能影响，更主要是CBO优化在起作用。在MySQL中启发式优化与CBO优化并不冲突, 某种意义上是分工的两个部分。

"基于成本"的具体含义：基于数据库系统当前真实信息，主要是表和索引的统计信息（Statistics），对SQL多种可能的执行方案所需IO及CPU成本进行估算，取出一个估算出来代价最小的方案去执行。（成本估算模型，单独拉个二级标题，搜别的文章）

> MySQL并不像Oracle或其他一些数据库有plan cache, 因此每个客户端SQL语句都要经历一次相对完整的执行计划计算过程, SQL在实际执行前的CPU开销(甚至有IO开销)是相当大的, 这是未来可能存在优化点之一。

